<html>
  <head> </head>
  <body>
    <form>
      <button>Connect</button>
      <pre id="log"></pre>
      <input type="file" id="file-selector" multiple />
    </form>

    <script src="./env_variables.js"></script>
    <script src="./utils.js"></script>
    <script src="./read_files.js"></script>
    <script src="./ota_helper.js"></script>
    <script src="./webble_ace.js"></script>

    <script>
      let otaControl = new Uint8Array(1);

      document
        .querySelector("form")
        .addEventListener("submit", function (event) {
          event.stopPropagation();
          event.preventDefault();

          if (isWebBLEAvailable()) {
            writeOtaData();
          }
        });

      function writeOtaData() {
        try {
          var value = new Uint8Array(MTU - 3);

          //Recorrer file en segmentos de MTU-3 y en cada recorrido acceder a la characteristic correspondiente y hacer el write.
          let options = {
            filters: [{ name: ENV.DEVICENAME }],
            optionalServices: [ENV.SVC_OTA],
          };

          navigator.bluetooth
            .requestDevice(options)
            .then((device) => {
              log("Connecting to GATT Server...");
              return device.gatt.connect();
            })
            .then((server) => {
              log("Gatt server status: " + server.connected);
              log("Getting Service...");
              return server.getPrimaryService(ENV.SVC_OTA);
            })
            .then((service) => {
              log("Gatt service uuid: " + service.uuid);
              log("Getting Characteristics async...");
              sendStartOta(service);
              //return service.getCharacteristic(WRITE_OTA_DATA);
            })
            .catch((error) => {
              this.isLoader = false;
              this.errorMessage = error.message;
              log("Argh! " + error);
              log("Message! " + errorMessage);
            });
          //Fin del for
        } catch (error) {
          this.errorMessage = error.message;
          log("Argh! " + error);
          log("Message! " + errorMessage);
        }
      }

      async function sendStartOta(service) {
        try {
          log("Start OTA Control...");
          otaControl[0] = ENV.START_OTA;
          let characteristic = await service.getCharacteristic(ENV.CHR_OTA);
          log("Write Start OTA Control Value...");
          let result = await characteristic.writeValue(otaControl);
          log("Writing result: " + result);
        } catch (error) {
          this.errorMessage = error.message;
          log("Argh! " + error);
          log("Message! " + errorMessage);
        }
      }

      async function sendEndOta(service) {
        try {
          log("End OTA Control...");
          otaControl[0] = ENV.END_OTA;
          let characteristic = await service.getCharacteristic(ENV.CHR_OTA);
          log("Write End OTA Control Value...");
          let result = await characteristic.writeValue(otaControl);
          log("Writing result: " + result);
        } catch (error) {
          this.errorMessage = error.message;
          log("Argh! " + error);
          log("Message! " + errorMessage);
        }
      }
    </script>
  </body>
</html>
