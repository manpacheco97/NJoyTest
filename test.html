<html>
 <head>
 </head>
 <body>
  <form>
   <button>Connect</button>
   <pre id="log"></pre>
  </form>
  
  <script>
   var Output = {
    log: function() {
      var line = Array.prototype.slice.call(arguments).map(function(argument) {
        return typeof argument === 'string' ? argument : JSON.stringify(argument);
      }).join(' ');

      document.querySelector('#log').textContent += line + '\n';
    },

    clearLog: function() {
      document.querySelector('#log').textContent = '';
    },
  };
  log = Output.log;
  var deviceName = 'Ace'
    function isWebBLEAvailable(){
      if(!navigator.bluetooth){
        log("Web Bluetooth is not available!")
        return false
      }
      Output.clearLog()
      return true
    }

    function getDeviceInfo(){
      let options ={
        filters: [
          { name: deviceName }
        ]
      }

      log('Requesting BLE device info...')
      navigator.bluetooth.requestDevice(options)
      .then(device => {
        log('Connecting to GATT Server...');
        return device.gatt.connect();
      })
      .then(server => {
        log('Getting Services...');
        return server.getPrimaryServices();
      })
      .then(services => {
        log('Getting Characteristics...');
        let queue = Promise.resolve();
        services.forEach(service => {
          queue = queue.then(_ => service.getCharacteristics().then(characteristics => {
            log('> Service: ' + service.uuid);
            characteristics.forEach(characteristic => {
              log('>> Characteristic: ' + characteristic.uuid + ' ' +
                  getSupportedProperties(characteristic));
            });
          }));
        });
        return queue;
      })
      .catch(error => {
        log('Argh! ' + error);
      });
    }
   function hex_to_ascii(str1)
    {
     var hex  = str1.toString();
     var str = '';
     for (var n = 0; n < hex.length; n += 2) {
      str += String.fromCharCode(parseInt(hex.substr(n, 2), 16));
     }
     return str;
    }
    function getCharacteristic(){
      const SVC_PASSWORD = '20aa23ad-b931-4a31-b08a-6f2a38c7b3cd'
      const CHR_PASSWORD = '7df106ea-d3b0-ba05-977a-e1fdddf0e978' 
      const CHR_RNDOM_NMBR = 'bd28ebcc-3bc2-9723-123d-f0911fa21670'
      const CHR_UNLOCK_COUNT = 'ec18caf2-1e96-e9ee-6a3d-b413d5578150'
      
      const SVC_ACE_VAPING = 'ae506062-db3d-9992-c0e2-f346deef8fab'
      const CHR_POWER_LEVEL = '0c36dc5b-7af1-d9c1-12de-736622b97dda'
      const CHR_UNLCK_TIMEOUT = 'dad2d1d4-dbf7-ad85-842b-7107f5de655b'
      const CHR_UPDATE_PASSWORD = '48f8e136-3162-bc42-9006-d649882fc53da'
      


      const SVC_DEVICE_INFO = 0x180A
      const CHR_SYSTEM_ID = 0x2A23
      

      let options ={
        filters: [
          { name: deviceName }
        ],
        optionalServices: [SVC_ACE_VAPING, SVC_PASSWORD, SVC_DEVICE_INFO]
      }

      log('Requesting BLE device info...')
      navigator.bluetooth.requestDevice(options)
      .then(device => {
        log('Connecting to GATT Server...');
        return device.gatt.connect();
      })
      .then(server => {
        log('Gatt server status: ' + server.connected)
        log('Getting Service...');
        return server.getPrimaryService(SVC_PASSWORD);
        //return server.getPrimaryService(SVC_ACE_VAPING);
      }) 
      .then((service) => {
          log('Gatt service uuid: ' + service.uuid)
          log('Getting Characteristics...');
          return service.getCharacteristic(CHR_RNDOM_NMBR);
          //return service.getCharacteristic(CHR_UNLCK_TIMEOUT);
      })
      .then(characteristic => {
          //characteristic.startNotifications()
          log('Gatt characteristic uuid: ' + characteristic.uuid)
         // console.log('Characteristic value: '+ characteristic.value)
          return characteristic.readValue();
      })
      .then(value => {
          log('Entre en value')
          log(value);
          this.isLoader = false;
          //value = hex_to_ascii(value);
          log('De hex a ascii: ' + value);
          let decoder = new TextDecoder('utf-8');
          log(decoder.decode(value));
      })
      .catch(error => {
          this.isLoader = false;
          this.errorMessage = error.message;
          log('Argh! ' + error);
          log('Message! ' + errorMessage);
      });
    }

    document.querySelector('form').addEventListener('submit',
    function(event){
      event.stopPropagation();
      event.preventDefault();

      if(isWebBLEAvailable()){
        //getDeviceInfo()
        getCharacteristic()
      }
    }) 
  </script>
 </body>
</html>
