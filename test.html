<html>
  <head> </head>
  <body>
    <form>
      <button>Connect</button>
      <pre id="log"></pre>
      <input type="file" id="file-selector" multiple />
    </form>

    <script src="./env_variables.js"></script>
    <script src="./utils.js"></script>
    <script src="./read_files.js"></script>
    <script src="./ota_helper.js"></script>
    <script src="./webble_ace.js"></script>

    <script>
      document
        .querySelector("form")
        .addEventListener("submit", function (event) {
          event.stopPropagation();
          event.preventDefault();

          if (isWebBLEAvailable()) {
            //getDeviceInfo()
            //getCharacteristic()
            writeCharacteristic();
          }
        });

      function writeOtaData(data) {
        try {
          var value = new Uint8Array(MTU - 3);

          //Recorrer file en segmentos de MTU-3 y en cada recorrido acceder a la characteristic correspondiente y hacer el write.
          let options = {
            filters: [{ name: DEVICENAME }],
            optionalServices: [SVC_OTA],
          };

          //Iniciar OTA Service escribiendo el valor 0.
          startOta();

          //Comienzo del for
          navigator.bluetooth
            .requestDevice(options)
            .then((device) => {
              log("Connecting to GATT Server...");
              return device.gatt.connect();
            })
            .then((server) => {
              log("Gatt server status: " + server.connected);
              log("Getting Service...");
              return server.getPrimaryService(SVC_OTA);
            })
            .then((service) => {
              log("Gatt service uuid: " + service.uuid);
              log("Getting Characteristics...");
              return service.getCharacteristic(WRITE_OTA_DATA);
            })
            .then((characteristic) => {
              log("Gatt characteristic uuid: " + characteristic.uuid);
              //Hacer el write con la data del firmware.
              characteristic.writeValueWithResponse(value);
            })
            .catch((error) => {
              this.isLoader = false;
              this.errorMessage = error.message;
              log("Argh! " + error);
              log("Message! " + errorMessage);
            });
          //Fin del for
        } catch (error) {
          this.errorMessage = error.message;
          log("Argh! " + error);
          log("Message! " + errorMessage);
        }
      }
    </script>
  </body>
</html>
